# Descope .NET SDK - Copilot Instructions

## Project Overview

This is the Descope .NET SDK, which provides authentication and user management capabilities. The SDK uses Microsoft Kiota to auto-generate API client code from OpenAPI specifications.

## Key Architectural Decisions

### Kiota Code Generation

- Generated code is in `Descope/Generated/Mgmt/` (Management API) and `Descope/Generated/Auth/` (Auth API)
- **NEVER manually edit generated files** - they are regenerated by `make generate`
- After making changes to OpenAPI specs or generation config, run `make` to regenerate and rebuild

### Extension Methods Pattern

The SDK provides extension methods to wrap Kiota-generated methods with cleaner, more intuitive APIs:

1. **AuthExtensions.cs** (`Descope/Sdk/Auth/AuthExtensions.cs`):
   - `WithJwt` methods: Operations requiring a refresh JWT
   - `WithKey` methods: Operations requiring an access key
   - Query parameter helpers for SSO flows

2. **MgmtExtensions.cs** (`Descope/Sdk/Mgmt/MgmtExtensions.cs`):
   - `WithId` methods: Loading entities by ID
   - `WithTenantId` methods: Tenant-scoped operations
   - `WithIdentifier` methods: Flexible user lookups

**When adding extension methods:**
- Make implicit requirements (like JWTs) explicit in method signatures
- Add validation with clear `DescopeException` messages
- Include XML documentation with usage examples
- Add entry to `Obsolete.csv` to mark the wrapped generated method as obsolete

### Obsolete Annotations

- `Obsolete.csv` defines which generated methods should be marked `[Obsolete]`
- Format: `RelativeFilePath,Method,Replacement`
- Applied automatically by `make post-process-obsolete` during generation

## Common Development Workflows

### Making Changes

```bash
# Regenerate Kiota files and build
make

# Run quick tests (net8.0 only)
make test-quick

# Run all tests (all frameworks)
make test
```

### Test Structure

- **UnitTests/**: Fast, isolated tests using mocks
- **IntegrationTests/**: Tests against real APIs (require `appsettingsTest.json`)
- Integration tests are rate-limited - see `Descope.Test/IntegrationTests/RATE_LIMITING.md`
- **When writing integration tests:** Use `RetryUntilSuccessAsync` from `RateLimitedIntegrationTest` when performing an action and then verifying it by loading an entity. This handles eventual consistency issues where changes may take a moment to propagate.
  ```csharp
  await RetryUntilSuccessAsync(async () => 
  {
      var entity = await client.LoadEntityAsync(id);
      Assert.Equal(expectedValue, entity.Property);
  });
  ```

### Client Configuration

```csharp
var options = new DescopeClientOptions
{
    ProjectId = "required",
    ManagementKey = "optional",
    AuthManagementKey = "optional",
    BaseUrl = "optional",
    FgaCacheUrl = "optional",
    IsUnsafe = false
};
```

### Usage Patterns

**Dependency Injection (Recommended):**
```csharp
services.AddDescopeClient(options);
```

**Factory (Instance-based):**
```csharp
var client = DescopeManagementClientFactory.Create(options);
```

## Token Validation Methods

1. **ValidateSessionAsync**: Local validation using cached public keys (fast)
2. **RefreshSessionAsync**: Remote API call to refresh token
3. **ValidateAndRefreshSession**: Try local validation first, fall back to refresh

## Custom Middleware

Located in `Descope/Sdk/Internal/Middleware/`:

1. **FixRootResponseBodyHandler**: Corrects OpenAPI inconsistencies for flat response structures
2. **FgaCacheUrlHandler**: Routes FGA operations to alternate cache URL when configured

When adding middleware, register in both `DescopeClientFactory.cs` and `DescopeServiceCollectionExtensions.cs`.

## Code Style Guidelines

- Follow existing naming patterns for extension methods
- Use XML documentation for public APIs
- Validate parameters and throw `DescopeException` with descriptive messages
- Never edit generated files directly
- Add tests for new functionality

## Important Files

- `Makefile`: Build, test, and generation commands
- `Obsolete.csv`: Defines obsolete method annotations
- `Descope/Sdk/Auth/AuthExtensions.cs`: Auth operation extensions
- `Descope/Sdk/Mgmt/MgmtExtensions.cs`: Management operation extensions
- `README.md`: User-facing documentation
- `README-maintainer.md`: Detailed maintainer guide
